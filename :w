#include "pid.hpp"
#include "right_trace.hpp"
#include "util.h"

#include "onoff_control.hpp"

#include "mileage_stopper.hpp"
#include "gray_stopper.hpp"
#include "line_stopper.hpp"
#include "angle_stopper.hpp"

#include "pid_trace.hpp"


void pidRun_R(ie::Motion& motion, float target){
    //↓ Rコース

    ie::MileageStopper ms;
    ie::GrayStopper gs(target*1.5);
    ie::AngleStopper as(90);
    ie::OnOffControl stControl(0, 0.3, 0);
    ie::PidTrace pid(motion, target, false);

    int mile = 300;
    pid.setTarget(target);
    ms.setTargetMileage(mile);
    pid.pid(ms, 40, 2, 0.75);
    //sharpCurvePid(motion,ms, target, 40, 0.75); // 強カーブ7割
    soundBeep();

    mile = 1950;
    pid.setTarget(target);
    ms.setTargetMileage(mile);
    pid.pid(ms, 100, 0, 1.0);
    //0Pid(motion,ms, target, 100, 1.0); // 直線
    soundBeep();

//    double targetDev = target - 50.0;
	double targetDev = target - 10.0;
    mile = 2750;
    pid.setTarget(targetDev);
    ms.setTargetMileage(mile);
    pid.pid(ms, 80, 2, 0.7);
    //sharpCurvePid(motion,ms, targetDev, 80, 0.70); // 強カーブ7割
    soundBeep();

    mile = 2300;
    pid.setTarget(target);
    ms.setTargetMileage(mile);
    pid.pid(ms, 40, 2, 0.75);
    //sharpCurvePid(motion,ms, target, 40, 0.75); // 強カーブ7割
    soundBeep();

    mile = 1280;
    ms.setTargetMileage(mile);
    targetDev = target - 10;
    pid.setTarget(targetDev);
    pid.pid(ms, 50, 2, 0.30);
    //sharpCurvePid(motion,ms, targetDev, 50, 0.30); // 強カーブ4割
    soundBeep();

    mile = 1700-200;
    ms.setTargetMileage(mile);
    pid.setTarget(target);
    pid.pid(ms, 100, 0, 1.0);
    //0Pid(motion,ms, target, 100, 1.0); // 直線
    soundBeep();
    //↑ Rコース

    //↓ 踏切おろし
    //Basic後灰色一旦通り過ぎる
    targetDev = target + 40;
    mile = 800;
    pid.setTarget(targetDev);
    ms.setTargetMileage(mile);
    pid.pid(ms, 20, 2, 10.0);
    //sharpCurvePid(motion,ms, targetDev, 20, 10.0); // 強カーブ15割
    soundBeep();

    //180度右へ
    motion.spin(as, stControl, 10);
    ie::LineStopper ls(target*0.75);
    motion.spin(ls, stControl, 10);

    //反転後灰色直前まで進む
    targetDev = target + 40;
    mile = 600;
    pid.setTarget(targetDev);
    ms.setTargetMileage(mile);
    pid.pid(ms, 20, 2, 10.0);
    //sharpCurvePid(motion,ms, targetDev, 20, 10.0); // 強カーブ15割
    soundBeep();

    //灰色検知
    pid.pid(gs, 20, 2, 10.0);
    //sharpCurvePid(motion,gs, target, 20, 10.0); // 強カーブ15割
    soundBeep();

    mile = 800;
    ms.setTargetMileage(mile);
    pid.setTarget(target);
    pid.pid(ms, 20, 2, 10.0);
    sharpCurvePid(motion,ms, target, 20, 10.0); // 強カーブ15割
    soundBeep();


    //90度右へ
    motion.spin(as, stControl, 10);
    soundBeep();

    motion.stop();



    //↑ 踏切おろし

    //↓ Besic後
    targetDev = target + 40;
    mile = 890;
    pid.setTarget(targetDev);
    ms.setTargetMileage(mile);
    pid.pid(ms, 20, 2, 10.0);
    //sharpCurvePid(motion,ms, targetDev, 20, 10.0); // 強カーブ15割
    soundBeep();

    // mile = 720;
    targetDev = target - 20;
    mile = 300 + 150;
    pid.setTarget(targetDev);
    ms.setTargetMileage(mile);
    pid.pid(ms, 20, 2, 10.0);
    //sharpCurvePid(motion,ms, targetDev, 20, 4.0); // 強カーブ15割
    soundBeep();
}
